name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Node (Backend)
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Backend Dependencies
      run: |
        cd back-end
        npm install

    - name: Run Backend Tests
      run: |
        cd back-end
        npm test
      env:
        CI: true 
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        PORT: 5001

    - name: Setup Node (Frontend)
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Frontend Dependencies
      run: |
        cd front-end 
        npm install

    - name: Run Frontend Tests 
      run: |
        cd front-end
        npm test
      env:
        CI: true 

    - name: Build Frontend
      run: |
        cd front-end
        npm run build

  deploy:
    needs: test  
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' 

    steps:
    - name: Deploy to Digital Ocean
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/app
          git reset --hard HEAD
          ./deploy.sh